

---===================================================---
---Table 2: Non AATD-related Emphysema Patients Cohort
---===================================================---


---===================================================================---
---1.1 Patients observable in the database on or after January 1, 2016
---===================================================================---
       
SELECT * FROM PRJ_XPLR_MKTSCAN_STD_A_STG.MARKETSCAN_STD_A_MED_AND_RX_CONTINUOUS_ENROLLMENT_30D_GAP_FOR_REQUESTS_202503
LIMIT 10;

---Description : Here we are using same table we craeted earlier during the creation of Table1 cohort
---"PRJ_XPLR_MKTSCAN_STD_A_STG.AATD_EMP_PATS_OBSRV_SG_1"

SELECT COUNT(DISTINCT ENROLID) AS PATS
FROM PRJ_XPLR_MKTSCAN_STD_A_STG.AATD_EMP_PATS_OBSRV_SG_1;

--PATS
--95443760

SELECT * FROM PRJ_XPLR_MKTSCAN_STD_A_STG.AATD_EMP_PATS_OBSRV_SG_1 LIMIT 10;


---==================================================================================================================================---
---1.2. Patients with ≥1 inpatient claim OR ≥2 outpatient claims (≥30 days apart and ≤365 days between) with a diagnosis of emphysema 
---     (ICD-10-CM: J43.x); index date is date of first emphysema diagnosis
---==================================================================================================================================---

CREATE OR REPLACE TABLE PRJ_XPLR_MKTSCAN_STD_A_STG.AATD_EMP_IP_OP_CLAIMS_COH2_SG_1 AS
WITH EMPHYSEMA_CLAIMS AS (
    SELECT ENROLID, DX_DT, POS_CATEGORY 
    FROM PRJ_XPLR_MKTSCAN_STD_A_STG.MARKETSCAN_STD_A_DIAGNOSIS_EVENTS_ALL_INSURANCES_POS_FOR_REQUESTS_202503
    WHERE DX LIKE 'J43%'
),

-- PATIENTS WITH >=1 INPATIENT CLAIM
INPATIENT AS (
    SELECT ENROLID, DX_DT
    FROM EMPHYSEMA_CLAIMS
    WHERE POS_CATEGORY IN ('ip')
),

-- PATIENTS WITH >=2 OUTPATIENT CLAIMS (>=30 DAYS APART AND <=365 DAYS BETWEEN)
OUTPATIENT_PAIRS AS (
    SELECT DISTINCT A.ENROLID, A.DX_DT
    FROM EMPHYSEMA_CLAIMS A
    JOIN EMPHYSEMA_CLAIMS B
      ON A.ENROLID = B.ENROLID
     AND A.POS_CATEGORY IN ('op', 'er', 'ltc', 'other')
     AND B.POS_CATEGORY IN ('op', 'er', 'ltc', 'other')
     AND B.DX_DT > A.DX_DT
     AND DATEDIFF(DAY, A.DX_DT, B.DX_DT) BETWEEN 30 AND 365
),
FINAL1 AS(
-- Combine both criteria
SELECT DISTINCT ENROLID, DX_DT
FROM INPATIENT
UNION ALL
SELECT DISTINCT ENROLID, DX_DT
FROM OUTPATIENT_PAIRS
),
FINAL2 AS (
SELECT ENROLID, MIN (DX_DT) AS INDEX_DT
FROM FINAL1
GROUP BY ENROLID
)
SELECT DISTINCT A.*, B.GENDER, B.DOBYR
FROM FINAL2 AS A
INNER JOIN 
PRJ_XPLR_MKTSCAN_STD_A_STG.AATD_EMP_PATS_OBSRV_SG_1 AS B
ON A.ENROLID = B.ENROLID
;



SELECT COUNT(*) AS CNT, COUNT(DISTINCT ENROLID) AS PATS
FROM PRJ_XPLR_MKTSCAN_STD_A_STG.AATD_EMP_IP_OP_CLAIMS_COH2_SG_1;

--CNT	PATS
--359401	358206


---Here we onserved that few patients have multiple Gender or DOBYR so am excluding those patients in the below step

CREATE OR REPLACE TABLE PRJ_XPLR_MKTSCAN_STD_A_STG.AATD_EMP_IP_OP_CLAIMS_COH2_SG_2 AS
WITH TBL1 AS (
    SELECT ENROLID, COUNT(*) AS CNT
    FROM PRJ_XPLR_MKTSCAN_STD_A_STG.AATD_EMP_IP_OP_CLAIMS_COH2_SG_1
    GROUP BY ENROLID
    HAVING COUNT(*) > 1
)
SELECT * 
FROM PRJ_XPLR_MKTSCAN_STD_A_STG.AATD_EMP_IP_OP_CLAIMS_COH2_SG_1
WHERE ENROLID NOT IN (SELECT DISTINCT ENROLID FROM TBL1)
;

SELECT COUNT(*) AS CNT, COUNT(DISTINCT ENROLID) AS PATS
FROM PRJ_XPLR_MKTSCAN_STD_A_STG.AATD_EMP_IP_OP_CLAIMS_COH2_SG_2;

--CNT	    PATS
--357460	357460


SELECT * FROM PRJ_XPLR_MKTSCAN_STD_A_STG.AATD_EMP_IP_OP_CLAIMS_COH2_SG_2 LIMIT 10;


---====================================================================---
---1.3. Patients age ≥18 years on the date of first emphysema diagnosis---
---====================================================================---

CREATE OR REPLACE TABLE PRJ_XPLR_MKTSCAN_STD_A_STG.AATD_EMP_PATS_AGE_COH2_SG_1 AS
SELECT DISTINCT
    ENROLID,
    INDEX_DT,
    GENDER,
    DOBYR,
    (YEAR(INDEX_DT) - DOBYR) AS AGE_AT_DIAGNOSIS
FROM PRJ_XPLR_MKTSCAN_STD_A_STG.AATD_EMP_IP_OP_CLAIMS_COH2_SG_2
WHERE (YEAR(INDEX_DT) - DOBYR) >= 18;


SELECT COUNT(*) AS CNT, COUNT(DISTINCT ENROLID) AS PATS
FROM PRJ_XPLR_MKTSCAN_STD_A_STG.AATD_EMP_PATS_AGE_COH2_SG_1;

--CNT	    PATS
--355041	355041

SELECT * FROM PRJ_XPLR_MKTSCAN_STD_A_STG.AATD_EMP_PATS_AGE_COH2_SG_1 LIMIT 10;


---================================================================================================---
---1.4. Patients without AATD diagnosis or evidence of augmentation therapy during the study period---
---================================================================================================---


CREATE OR REPLACE TABLE PRJ_XPLR_MKTSCAN_STD_A_STG.AATD_EMP_PATS_AUG_THERAPY_COH2_SG_1 AS
WITH TBL1 AS (
SELECT A.*
FROM PRJ_XPLR_MKTSCAN_STD_A_STG.AATD_EMP_PATS_AGE_COH2_SG_1 AS A
INNER JOIN 
     PRJ_XPLR_MKTSCAN_STD_A_STG.marketscan_std_a_ndc_events_all_insurances_for_requests_202503 AS B
   ON A.ENROLID = B.ENROLID
WHERE B.NDC IN ('13533070002', '00026060135', '00026060130', '00053720102', '00053720302', '00053721101', '00053721201', '00053721301', '00053765312', '00053765320', '00053765380',
'00161060135', '00192060130', '00192060135', '00338280101', '00338280102', '00530720102', '00530765320', '00537020202', '00537020302', '00944280101', '00944280102',
'00944280201', '00944280202', '00944280303', '00944280404', '00944281201', '00944281401', '00944281501', '00944282202', '00944288401', '00944288402', '00944288403',
'00944288404', '00944288405', '00944288406', '04959110502', '13533000006', '13533020020', '13533060130', '13533060135', '13533070001', '13533070011', '13533070101',
'13533070211', '13533070310', '13533070501', '13533070511', '13533070531', '13533070532', '13533070551', '13533070552', '13533070622', '24558280201', '24558280202',
'49669580001', '49669580002', '52919001412', '57516010102', '57516010201', '57516010320', '57516011002', '57516011101', '57516011220', '57516011302', '57516011401',
'57516011520', '64764051825', '64764051950', '76297000222')
),
TBL2 AS (
SELECT A.*
FROM PRJ_XPLR_MKTSCAN_STD_A_STG.AATD_EMP_PATS_AGE_COH2_SG_1 AS A
INNER JOIN 
     PRJ_XPLR_MKTSCAN_STD_A_STG.marketscan_std_a_procedure_events_all_insurances_pos_for_requests_202503 AS B
   ON A.ENROLID = B.ENROLID
WHERE B.PROC IN ('J0256', 'J0257', 'S9346')
),
TBL3 AS (
SELECT A.*
FROM PRJ_XPLR_MKTSCAN_STD_A_STG.AATD_EMP_PATS_AGE_COH2_SG_1 AS A
INNER JOIN 
     PRJ_XPLR_MKTSCAN_STD_A_STG.marketscan_std_a_diagnosis_events_all_insurances_pos_for_requests_202503 AS B
   ON A.ENROLID = B.ENROLID
WHERE B.DX LIKE 'J43%'
),
TBL4 AS (
SELECT * FROM TBL1
UNION ALL
SELECT * FROM TBL2
UNION ALL
SELECT * FROM TBL3
)
SELECT *
FROM PRJ_XPLR_MKTSCAN_STD_A_STG.AATD_EMP_PATS_AGE_COH2_SG_1
WHERE ENROLID NOT IN (SELECT DISTINCT ENROLID FROM TBL4)
;


SELECT COUNT(*) AS CNT, COUNT(DISTINCT ENROLID) AS PATS
FROM PRJ_XPLR_MKTSCAN_STD_A_STG.AATD_EMP_PATS_AUG_THERAPY_COH2_SG_1;

--CNT	PATS
--137	137

--CNT	PATS
--355041	355041

---AATD

--CNT	    PATS
--355041	355041


---CNT	PATS
--739	739

--CNT	PATS
--539	539
